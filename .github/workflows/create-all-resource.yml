name: Create all the terraform resources
on:
  workflow_dispatch:

env:
  GOOGLE_CREDENTIALS: ${{ secrets.TEST_CICD_SA }}
  ENV: test

jobs:
  vpc:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.6

      - name: "Creation Of VPC"
        run: |
          cd vpc/
          terraform init -backend-config=envs/$ENV/backend.tfvars
          terraform plan -input=false --var-file=envs/$ENV/terraform.tfvars -out=tf.plan
          terraform apply tf.plan
  lb-cloudrun-sql:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    needs: vpc 
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.6

      - name: "Creation Of LoadBalancer,CloudRun and CloudSQL"
        run: |
          cd lb-cloudrun-sql/
          terraform init -backend-config=envs/$ENV/backend.tfvars
          terraform plan -input=false --var-file=envs/$ENV/terraform.tfvars -out=tf.plan
          terraform apply tf.plan
